<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSKedai Master</title>
    <style>
        :root { --primary: #f97316; --success: #10b981; --warning: #f59e0b; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100; }
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
        .nav-tab { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; transition: 0.3s; }
        .nav-tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: bold; }
        
        /* Privasi UI */
        .admin-only { display: none !important; }
        .is-admin .admin-only { display: block !important; }
        
        /* Menu & Cart */
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .menu-item { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        
        /* QR & Receipt Modal */
        .qr-card { background: white; border: 2px dashed var(--primary); border-radius: 15px; padding: 20px; text-align: center; margin: 15px 0; }
        .qr-img-large { width: 100%; max-width: 250px; border-radius: 10px; }
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:1001; width:90%; max-width:400px; }
        .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
        .btn-wa { background:#25D366; color:white; border:none; padding:12px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; margin-top:10px; font-size: 1rem; }
        
        .order-card { background: white; margin-bottom: 10px; padding: 15px; border-radius: 10px; border-left: 5px solid var(--success); }
        .order-card.pending { border-left-color: var(--warning); }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; }
    </style>
</head>
<body id="appBody">

<div id="loginScreen" style="padding: 50px 20px; text-align: center;">
    <h2>POSKedai Login</h2>
    <input type="password" id="pinInput" placeholder="Masukkan PIN Staff" style="padding:15px; width:80%; max-width:250px; border-radius:8px; border:1px solid #ccc; font-size:1.2rem; text-align:center;">
    <br><br>
    <button onclick="doLogin()" style="padding:15px 40px; background:var(--primary); color:white; border:none; border-radius:8px; font-size:1.1rem;">Masuk</button>
</div>

<div id="appContainer" style="display:none;">
    <div class="header">
        <strong id="shopTitle">POSKedai</strong>
        <span id="staffDisplay" style="font-size: 0.9rem;"></span>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('order', this)">üõí POS</button>
        <button class="nav-tab" onclick="switchTab('list', this)">üìã Senarai</button>
        <button class="nav-tab admin-only" onclick="switchTab('menu', this)">üç¥ Menu</button>
        <button class="nav-tab admin-only" onclick="switchTab('sales', this)">üìä Jualan</button>
    </div>

    <div id="tab-order" class="container tab-content">
        <input type="text" id="tableNo" placeholder="No. Meja (cth: A12)" style="width:100%; padding:10px; box-sizing:border-box; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;">
        <div class="menu-grid" id="menuDisplay"></div>
        <hr>
        <h3>Troli <span id="editModeBadge"></span></h3>
        <div id="cartList" style="background:white; padding:10px; border-radius:10px; min-height:50px; margin-bottom:10px;"></div>
        
        <div class="qr-card">
            <p style="margin:0 0 10px 0;"><strong>üì± Imbas untuk Bayar</strong></p>
            <img src="" id="qrPreview" class="qr-img-large">
        </div>

        <button onclick="saveOrder('pending')" style="background:var(--warning); color:white; width:100%; padding:15px; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px;">üíæ SIMPAN (MAKAN DULU)</button>
        <button onclick="saveOrder('completed')" style="background:var(--success); color:white; width:100%; padding:15px; border:none; border-radius:8px; font-weight:bold;">‚úÖ BAYAR SEKARANG</button>
    </div>

    <div id="tab-list" class="container tab-content" style="display:none;">
        <input type="date" id="filterDate" onchange="loadOrders()" style="width:100%; padding:10px; margin-bottom:15px;">
        <div id="ordersDisplay"></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="receiptModal">
    <div id="receiptContent" style="font-family:monospace; white-space:pre-wrap; background:#f9f9f9; padding:10px; font-size:0.9rem;"></div>
    <button class="btn-wa" onclick="shareToWhatsApp()">üü¢ SHARE WHATSAPP</button>
    <button onclick="closeModal()" style="width:100%; margin-top:8px; padding:10px; background:#eee; border:none; border-radius:8px;">TUTUP</button>
</div>

<script>
const C = { 
    URL: "URL_GAS_ANDA_DI_SINI", 
    KEY: "aca6f58aac70a3c722e74b9e0488bd693637e056de95a296f6b40613104b1df7" 
};

let S = { staff: null, cart: [], menu: [], editId: null, shop: {}, lastOrder: null };

async function api(action, data) {
    try {
        const r = await fetch(C.URL, {
            method: 'POST',
            body: JSON.stringify({ apiKey: C.KEY, action, data })
        });
        return await r.json();
    } catch(e) { alert("Ralat sambungan server!"); return {success:false}; }
}

async function doLogin() {
    const pin = document.getElementById('pinInput').value;
    const r = await api('login', { pin });
    if(r.success) {
        S.staff = r.staff;
        if(S.staff.role === 'admin') document.getElementById('appBody').classList.add('is-admin');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('staffDisplay').innerText = "üë§ " + S.staff.name;
        initApp();
    } else { alert("PIN Salah!"); }
}

async function initApp() {
    const info = await api('getShopInfo');
    S.shop = info;
    document.getElementById('shopTitle').innerText = info.SHOP_NAME || "POSKedai";
    document.getElementById('qrPreview').src = info.QR_IMAGE;
    document.getElementById('filterDate').valueAsDate = new Date();
    loadMenu();
}

async function loadMenu() {
    const r = await api('getMenu');
    if(r.success) {
        S.menu = r.menu;
        let html = '';
        r.menu.forEach(m => {
            html += `<div class="menu-item" onclick="addToCart('${m.id}')">
                <strong>${m.name}</strong><br>
                <span style="color:var(--primary)">RM${m.price.toFixed(2)}</span>
            </div>`;
        });
        document.getElementById('menuDisplay').innerHTML = html;
    }
}

function addToCart(id) {
    const item = S.menu.find(m => m.id === id);
    const exist = S.cart.find(c => c.id === id);
    if(exist) { exist.qty++; } 
    else { S.cart.push({ ...item, qty: 1 }); }
    renderCart();
}

function renderCart() {
    let html = '';
    S.cart.forEach((c, idx) => {
        html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${c.name} x${c.qty}</span>
            <span>RM${(c.price * c.qty).toFixed(2)} <button onclick="removeFromCart(${idx})" style="color:red; border:none; background:none;">X</button></span>
        </div>`;
    });
    document.getElementById('cartList').innerHTML = html || 'Troli kosong';
    document.getElementById('editModeBadge').innerHTML = S.editId ? '<span class="badge" style="background:red;">MOD EDIT</span>' : '';
}

function removeFromCart(idx) { S.cart.splice(idx,1); renderCart(); }

async function saveOrder(status) {
    if(S.cart.length === 0) return alert("Troli kosong!");
    const tableNo = document.getElementById('tableNo').value;
    
    const r = await api('saveOrder', {
        orderId: S.editId,
        items: S.cart,
        status: status,
        tableNo: tableNo,
        staffName: S.staff.name,
        staffRole: S.staff.role
    });

    if(r.success) {
        S.lastOrder = r.order;
        S.cart = []; S.editId = null;
        document.getElementById('tableNo').value = '';
        renderCart();
        if(status === 'completed') { showReceipt(r.order); } 
        else { alert("Pesanan disimpan!"); }
        loadOrders();
    }
}

async function loadOrders() {
    const date = document.getElementById('filterDate').value;
    const r = await api('getOrders', { date, staffName: S.staff.name, staffRole: S.staff.role });
    if(r.success) {
        let html = '';
        r.orders.forEach(o => {
            html += `<div class="order-card ${o.status}">
                <div style="display:flex; justify-content:space-between;">
                    <strong>#${o.orderNo} - Meja ${o.tableNo}</strong>
                    <span>RM${o.total.toFixed(2)}</span>
                </div>
                <div style="font-size:0.8rem; color:#666;">${o.time} | Staff: ${o.staffName}</div>
                ${o.status === 'pending' ? `<button onclick="editOrder('${o.orderId}')" style="margin-top:10px; padding:5px 10px; background:var(--warning); border:none; border-radius:5px; color:white; cursor:pointer;">‚úèÔ∏è Edit / Tambah Item</button>` : ''}
            </div>`;
        });
        document.getElementById('ordersDisplay').innerHTML = html || 'Tiada pesanan.';
    }
}

function editOrder(id) {
    const orders = document.getElementById('ordersDisplay').innerHTML; // Quick check
    api('getOrders', { date: document.getElementById('filterDate').value, staffName: S.staff.name, staffRole: S.staff.role }).then(r => {
        const order = r.orders.find(o => o.orderId === id);
        S.cart = order.items;
        S.editId = order.orderId;
        document.getElementById('tableNo').value = order.tableNo;
        switchTab('order', document.querySelector('.nav-tab'));
        renderCart();
        alert("Mod Edit Aktif: Sila tambah item atau selesaikan bayaran.");
    });
}

function showReceipt(order) {
    let text = `   ${S.shop.SHOP_NAME || 'RESIT RASMI'}\n`;
    text += `   ${S.shop.SHOP_ADDRESS || ''}\n`;
    text += `----------------------------\n`;
    text += `No: #${order.orderNo} | Meja: ${order.tableNo}\n`;
    text += `Tarikh: ${order.date} ${order.time}\n`;
    text += `Staff: ${order.staffName}\n`;
    text += `----------------------------\n`;
    order.items.forEach(i => {
        text += `${i.name.padEnd(15)} x${i.qty} RM${(i.price*i.qty).toFixed(2)}\n`;
    });
    text += `----------------------------\n`;
    text += `TOTAL: RM${order.total}\n`;
    text += `----------------------------\n`;
    text += `Terima Kasih!`;
    
    document.getElementById('receiptContent').innerText = text;
    document.getElementById('receiptModal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function shareToWhatsApp() {
    const order = S.lastOrder;
    let phone = prompt("Masukkan No. WhatsApp Pelanggan (cth: 0123456789):");
    if(!phone) return;
    
    phone = phone.replace(/[^0-9]/g, "");
    if(phone.startsWith("0")) phone = "6" + phone;
    if(!phone.startsWith("6")) phone = "60" + phone;

    let msg = `*${S.shop.SHOP_NAME || 'RESIT'}*\n`;
    msg += `No. Pesanan: #${order.orderNo}\n`;
    msg += `Meja: ${order.tableNo}\n`;
    msg += `--------------------------\n`;
    order.items.forEach(i => { msg += `- ${i.name} x${i.qty}: RM${(i.price*i.qty).toFixed(2)}\n`; });
    msg += `--------------------------\n`;
    msg += `*TOTAL: RM${order.total}*\n`;
    msg += `Terima kasih!`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
}

function closeModal() {
    document.getElementById('receiptModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

function switchTab(tab, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.getElementById('tab-' + tab).style.display = 'block';
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    if(tab === 'list') loadOrders();
}
</script>
</body>
</html>

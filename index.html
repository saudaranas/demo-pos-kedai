<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POSKedai - Sistem POS Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- DESIGN ASAL ANDA (RETAINED) --- */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#f97316;--primary-dark:#ea580c;--primary-light:#fff7ed;--success:#34d399;--success-dark:#10b981;--danger:#f87171;--warning:#fbbf24;--dark:#0f172a;--white:#ffffff;--radius-lg:20px;--radius-xl:28px;--font:'Inter',-apple-system,sans-serif;--ease:cubic-bezier(0.4,0,0.2,1)}
        body{font-family:var(--font);background:#f1f5f9;color:var(--dark);min-height:100vh;-webkit-font-smoothing:antialiased}
        
        /* Login Screen */
        .login-screen{min-height:100vh;background:linear-gradient(145deg,#fff7ed 0%,#fed7aa 30%,#fdba74 100%);display:flex;align-items:center;justify-content:center;padding:24px}
        .login-card{background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);border-radius:var(--radius-xl);padding:48px 36px;width:100%;max-width:400px;box-shadow:0 24px 60px rgba(0,0,0,0.1);text-align:center}
        .pin-input{width:100%;padding:18px;border:2px solid #e2e8f0;border-radius:14px;font-size:1.5rem;text-align:center;letter-spacing:10px;margin-bottom:20px;font-weight:700}
        
        /* Header & Nav */
        .header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
        .nav-tabs{display:flex;background:white;position:sticky;top:0;z-index:99;padding:3px;gap:2px;border-bottom:1px solid #e2e8f0;overflow-x:auto}
        .nav-tab{flex:1;padding:12px 8px;text-align:center;cursor:pointer;border:none;background:transparent;font-size:0.75rem;font-weight:700;color:#94a3b8;transition:0.2s}
        .nav-tab.active{color:var(--primary);background:var(--primary-light);border-radius:12px}
        
        /* Layout & Content */
        .tab-content{display:none;padding:16px;max-width:1400px;margin:0 auto}
        .tab-content.active{display:block}
        .order-layout{display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start}
        
        /* Menu Grid */
        .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;flex:1}
        .menu-item{background:white;border:1.5px solid #e2e8f0;border-radius:16px;padding:16px 10px;text-align:center;cursor:pointer;transition:all 0.2s}
        .menu-item:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.05)}
        .menu-item .m-name{font-weight:700;font-size:0.85rem;margin:6px 0}
        .menu-item .m-price{color:var(--primary);font-weight:800;font-size:1rem}
        
        /* Cart Area */
        .order-right{width:100%;max-width:380px;position:sticky;top:70px}
        .card{background:white;border-radius:var(--radius-lg);padding:20px;box-shadow:0 4px 24px rgba(0,0,0,0.06)}
        .cart-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9;font-size:0.85rem}
        
        /* QR Card (BESAR) */
        .qr-card{text-align:center;border:2px dashed var(--primary);padding:20px;border-radius:20px;margin:15px 0;background:var(--primary-light)}
        .qr-img-large{width:100%;max-width:240px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
        
        /* Buttons */
        .btn-pay{width:100%;padding:16px;border:none;border-radius:14px;font-weight:800;cursor:pointer;font-size:0.95rem;transition:0.2s;margin-bottom:8px}
        .btn-save{background:var(--warning);color:white}
        .btn-complete{background:var(--success-dark);color:white}
        .btn-wa{background:#25D366;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-weight:700;cursor:pointer;margin-top:10px}
        
        /* Order Cards in List */
        .order-card{background:white;border-radius:16px;padding:16px;margin-bottom:12px;border-left:6px solid var(--success-dark);box-shadow:0 4px 12px rgba(0,0,0,0.04)}
        .order-card.pending{border-left-color:var(--warning)}
        .badge-pending{background:var(--primary-light);color:var(--primary-dark);padding:2px 8px;border-radius:6px;font-size:0.65rem;font-weight:800}

        /* Modal Resit */
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center}
        .modal{background:white;padding:28px;border-radius:28px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}

        /* Admin UI Privacy */
        .admin-only{display:none !important}
        .is-admin .admin-only{display:block !important}
    </style>
</head>
<body id="appBody">

<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <h1 style="color:var(--primary);font-weight:900;letter-spacing:-1px;font-size:2rem">POSKedai</h1>
        <p style="color:#64748b;font-size:0.85rem;margin-bottom:32px;font-weight:500">Sila masukkan PIN Staff</p>
        <input type="password" id="pinInput" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric">
        <button onclick="doLogin()" style="width:100%;padding:18px;background:var(--primary);color:white;border:none;border-radius:16px;font-weight:800;cursor:pointer;box-shadow:0 10px 20px rgba(249,115,22,0.2)">MASUK</button>
    </div>
</div>

<div id="appContainer" style="display:none">
    <div class="header">
        <span style="font-weight:900;font-size:1.2rem">POSKedai</span>
        <span id="staffBadge" style="background:rgba(255,255,255,0.2);padding:6px 14px;border-radius:20px;font-size:0.75rem;font-weight:600">üë§ Staff</span>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="go('order',this)">üõí PESANAN</div>
        <div class="nav-tab" onclick="go('list',this)">üìã SENARAI</div>
        <div class="nav-tab admin-only" onclick="go('menu',this)">üç¥ URUS MENU</div>
        <div class="nav-tab admin-only" onclick="go('sales',this)">üìä JUALAN</div>
    </div>

    <div id="tab-order" class="tab-content active">
        <div class="order-layout">
            <div id="menuGrid" class="menu-grid">
                </div>
            <div class="order-right">
                <div class="card">
                    <h3 style="margin-bottom:18px;display:flex;justify-content:space-between">
                        Troli <span id="editLabel" class="badge-pending" style="display:none">MOD EDIT</span>
                    </h3>
                    <input type="text" id="tableNo" placeholder="No. Meja (cth: A1)" style="width:100%;padding:14px;border:1.5px solid #e2e8f0;border-radius:12px;margin-bottom:12px;font-weight:700">
                    
                    <div id="cartList" style="min-height:50px;margin-bottom:15px">
                        </div>

                    <div class="qr-card">
                        <p style="font-size:0.75rem;font-weight:800;margin-bottom:10px;color:var(--primary-dark)">üì± IMBAS UNTUK BAYAR</p>
                        <img id="qrPreview" class="qr-img-large" src="">
                    </div>

                    <div style="display:flex;justify-content:space-between;font-weight:900;font-size:1.2rem;margin:20px 0;padding-top:15px;border-top:2px solid #f1f5f9">
                        <span>TOTAL</span>
                        <span id="cartTotal" style="color:var(--primary)">RM 0.00</span>
                    </div>

                    <button onclick="saveOrder('pending')" class="btn-pay btn-save">üíæ SIMPAN (MAKAN DULU)</button>
                    <button onclick="saveOrder('completed')" class="btn-pay btn-complete">‚úÖ BAYAR SEKARANG</button>
                    <button id="cancelEditBtn" onclick="resetCart()" style="display:none;width:100%;background:none;border:none;color:var(--danger);font-size:0.8rem;font-weight:700;margin-top:5px;cursor:pointer">BATAL EDIT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-list" class="tab-content">
        <div style="margin-bottom:20px;display:flex;gap:10px">
            <input type="date" id="filterDate" onchange="loadOrders()" style="flex:1;padding:12px;border-radius:12px;border:1.5px solid #e2e8f0;font-family:inherit;font-weight:600">
            <button onclick="loadOrders()" style="padding:0 20px;background:var(--primary);color:white;border:none;border-radius:12px;font-weight:700">REFRESH</button>
        </div>
        <div id="ordersDisplay">
            </div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center;margin-bottom:15px">Pesanan Berjaya!</h3>
        <div id="receiptContent" style="font-family:monospace;white-space:pre-wrap;background:#f8fafc;padding:20px;font-size:0.85rem;border-radius:16px;border:1px solid #e2e8f0;line-height:1.4"></div>
        <button class="btn-wa" onclick="shareToWhatsApp()">üü¢ SHARE KE WHATSAPP</button>
        <button onclick="closeModal()" style="width:100%;padding:12px;margin-top:10px;background:#f1f5f9;color:#64748b;border:none;border-radius:12px;font-weight:700;cursor:pointer">TUTUP</button>
    </div>
</div>

<script>
    // --- KONFIGURASI ---
    const C = { 
        URL: "URL_WEB_APP_GAS_ANDA", // <--- MASUKKAN URL GAS ANDA DI SINI
        KEY: "aca6f58aac70a3c722e74b9e0488bd693637e056de95a296f6b40613104b1df7" 
    };

    let S = { staff: null, cart: [], menu: [], editId: null, shop: {}, lastOrder: null, orders: [] };

    // --- API HANDLER ---
    async function api(action, data) {
        try {
            const r = await fetch(C.URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ apiKey: C.KEY, action, data }) 
            });
            return await r.json();
        } catch(e) {
            console.error(e);
            alert("Ralat sambungan server. Sila cuba lagi.");
            return { success: false, error: "Connection Failed" };
        }
    }

    // --- LOGIN ---
    async function doLogin() {
        const pin = document.getElementById('pinInput').value;
        if(!pin) return alert("Masukkan PIN!");
        
        const r = await api('login', { pin });
        if(r.success) {
            S.staff = r.staff;
            if(S.staff.role === 'admin') document.getElementById('appBody').classList.add('is-admin');
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('staffBadge').innerText = "üë§ " + S.staff.name;
            
            initApp();
        } else {
            alert("PIN Salah atau Masalah Server!");
        }
    }

    async function initApp() {
        const info = await api('getShopInfo');
        if(info.success) {
            S.shop = info;
            document.getElementById('qrPreview').src = info.QR_IMAGE || "";
        }
        document.getElementById('filterDate').valueAsDate = new Date();
        loadMenu();
    }

    // --- MENU & CART ---
    async function loadMenu() {
        const r = await api('getMenu');
        if(r.success) {
            S.menu = r.menu;
            renderMenu();
        }
    }

    function renderMenu() {
        let html = '';
        S.menu.forEach(m => {
            html += `
                <div class="menu-item" onclick="addToCart('${m.id}')">
                    <div style="font-size:0.6rem;color:#94a3b8;font-weight:700;text-transform:uppercase">${m.category}</div>
                    <div class="m-name">${m.name}</div>
                    <div class="m-price">RM${m.price.toFixed(2)}</div>
                </div>
            `;
        });
        document.getElementById('menuGrid').innerHTML = html;
    }

    function addToCart(id) {
        const item = S.menu.find(m => m.id === id);
        const exist = S.cart.find(c => c.id === id);
        if(exist) exist.qty++; else S.cart.push({...item, qty: 1});
        renderCart();
    }

    function renderCart() {
        let html = '';
        let total = 0;
        S.cart.forEach((c, i) => {
            const sub = c.price * c.qty;
            total += sub;
            html += `
                <div class="cart-item">
                    <span><strong>${c.name}</strong> x${c.qty}</span>
                    <span>RM${sub.toFixed(2)} <button onclick="removeFromCart(${i})" style="border:none;background:none;color:var(--danger);cursor:pointer;margin-left:8px;font-weight:bold">√ó</button></span>
                </div>
            `;
        });
        document.getElementById('cartList').innerHTML = html || '<p style="text-align:center;color:#94a3b8;font-size:0.8rem">Troli kosong</p>';
        document.getElementById('cartTotal').innerText = `RM ${total.toFixed(2)}`;
        
        // Edit mode UI
        document.getElementById('editLabel').style.display = S.editId ? 'inline' : 'none';
        document.getElementById('cancelEditBtn').style.display = S.editId ? 'block' : 'none';
    }

    function removeFromCart(i) {
        S.cart.splice(i, 1);
        renderCart();
    }

    function resetCart() {
        S.cart = [];
        S.editId = null;
        document.getElementById('tableNo').value = '';
        renderCart();
    }

    // --- ORDERS (SAVE & EDIT) ---
    async function saveOrder(status) {
        if(S.cart.length === 0) return alert("Pilih menu dahulu!");
        
        const table = document.getElementById('tableNo').value;
        if(!table) return alert("Masukkan No. Meja!");

        const data = {
            orderId: S.editId,
            items: S.cart,
            status: status,
            tableNo: table,
            staffName: S.staff.name,
            staffRole: S.staff.role
        };

        const r = await api('saveOrder', data);
        if(r.success) {
            S.lastOrder = r.order;
            resetCart();
            if(status === 'completed') {
                showReceipt(r.order);
            } else {
                alert(r.message);
            }
            if(document.getElementById('tab-list').style.display !== 'none') loadOrders();
        }
    }

    async function loadOrders() {
        const date = document.getElementById('filterDate').value;
        const r = await api('getOrders', { 
            date, 
            staffName: S.staff.name, 
            staffRole: S.staff.role 
        });
        
        if(r.success) {
            S.orders = r.orders;
            renderOrders();
        }
    }

    function renderOrders() {
        let html = '';
        S.orders.forEach(o => {
            const isPending = o.status === 'pending';
            html += `
                <div class="order-card ${isPending ? 'pending' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <strong style="font-size:1.1rem;color:var(--primary)">#${o.orderNo}</strong>
                        <span class="badge-pending" style="background:${isPending ? '#fef3c7' : '#ecfdf5'}; color:${isPending ? '#b45309' : '#047857'}">
                            ${o.status.toUpperCase()}
                        </span>
                    </div>
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:4px">ü™ë Meja: ${o.tableNo} | ‚è∞ ${o.time}</div>
                    <div style="font-size:0.75rem;color:#64748b;margin-bottom:8px">Staff: ${o.staffName}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9">
                        <span style="font-weight:800;font-size:1rem">RM${o.total.toFixed(2)}</span>
                        ${isPending ? `<button onclick="pullForEdit('${o.orderId}')" class="btn-pay btn-save" style="width:auto;padding:8px 16px;margin:0;font-size:0.75rem">‚úèÔ∏è EDIT / TAMBAH</button>` : ''}
                    </div>
                </div>
            `;
        });
        document.getElementById('ordersDisplay').innerHTML = html || '<p style="text-align:center;padding:40px;color:#94a3b8">Tiada pesanan untuk tarikh ini.</p>';
    }

    function pullForEdit(id) {
        const order = S.orders.find(o => o.orderId === id);
        if(!order) return;

        S.cart = JSON.parse(JSON.stringify(order.items)); // Deep copy
        S.editId = order.orderId;
        document.getElementById('tableNo').value = order.tableNo;
        
        renderCart();
        go('order', document.querySelector('.nav-tab'));
        window.scrollTo(0,0);
    }

    // --- WHATSAPP & MODAL ---
    function showReceipt(order) {
        let text = `   ${S.shop.SHOP_NAME || 'RESIT RASMI'}\n`;
        text += `   ${S.shop.SHOP_ADDRESS || ''}\n`;
        text += `----------------------------\n`;
        text += `No: #${order.orderNo} | Meja: ${order.tableNo}\n`;
        text += `Tarikh: ${order.date} ${order.time}\n`;
        text += `Staff: ${order.staffName}\n`;
        text += `----------------------------\n`;
        order.items.forEach(i => {
            text += `${i.name.padEnd(14)} x${i.qty} RM${(i.price*i.qty).toFixed(2)}\n`;
        });
        text += `----------------------------\n`;
        text += `TOTAL: RM${order.total}\n`;
        text += `----------------------------\n`;
        text += `Terima Kasih!`;
        
        document.getElementById('receiptContent').innerText = text;
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function shareToWhatsApp() {
        const order = S.lastOrder;
        let phone = prompt("Masukkan No. WhatsApp Pelanggan (cth: 0123456789):");
        if(!phone) return;
        
        phone = phone.replace(/[^0-9]/g, "");
        if(phone.startsWith("0")) phone = "6" + phone;
        if(!phone.startsWith("6")) phone = "60" + phone;

        let msg = `*${S.shop.SHOP_NAME || 'RESIT'}*\n`;
        msg += `No. Order: #${order.orderNo} | Meja: ${order.tableNo}\n`;
        msg += `--------------------------\n`;
        order.items.forEach(i => { msg += `- ${i.name} x${i.qty}: RM${(i.price*i.qty).toFixed(2)}\n`; });
        msg += `--------------------------\n`;
        msg += `*TOTAL: RM${order.total}*\n`;
        msg += `Terima kasih!`;

        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function go(tab, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById('tab-' + tab).style.display = 'block';
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(tab === 'list') loadOrders();
    }
</script>
</body>
</html>
